<template>

    <require from="app.scss"></require>
    <require from="library-aurelia/src/resources/elements/alert"></require>
    <require from="library-aurelia/src/resources/elements/nav-bar"></require>
    <require from="library-aurelia/src/resources/elements/toolbar/toolbar"></require>
    <require from="library-aurelia/src/resources/elements/toast"></require>
    <require from="library-aurelia/src/resources/value-converters/format-number"></require>
    <require from="library-aurelia/src/resources/attributes/bs-tooltip"></require>
    <require from='library-aurelia/src/resources/value-converters/format-date'></require>
    <require from="library-aurelia/src/resources/value-converters/format-duration"></require>
    <require from="resources/elements/custom-content-items/custom-content-item-severity.html"></require>
    <require from="resources/elements/custom-content-items/custom-content-item-role.html"></require>
    <require from="resources/elements/custom-content-items/custom-content-item-status.html"></require>
    <require from="resources/elements/user-abbreviation"></require>

    <nav-bar class="bg-body-tertiary rounded mb-1"
             display-is-navigating.bind="true"
             css="navbar-expand-md bg-body-tertiary rounded"
             brand.bind="{iconSource: 'assets/icon-pathocert.png'}">

        <div class="${dropUp ? 'dropdown' : 'dropup'}"
             if.bind="contextService.emergencyEvents">
            <button class="btn btn-link nav-link  py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="emergency-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-hospital-fill"></i>
                <span if.bind="contextService.currentEmergencyEvent" class="d-inline d-md-none d-xl-inline ms-2">${contextService.currentEmergencyEvent.name}</span>
                <span else class="d-inline d-md-none d-xl-inline ms-2">${'alerts.noEmergencyEventSelected' | t}</span>
            </button>
            <div class="emergency-menu dropdown-menu dropdown-menu-lg-end" aria-labelledby="emergency-menu">
                <ul class="list-unstyled mb-2 overflow-auto">
                    <li repeat.for="emergencyEvent of contextService.emergencyEvents">
                        <button class="dropdown-item ${contextService.currentEmergencyEvent === emergencyEvent ? 'active' : ''}"
                                click.trigger="contextService.changeEmergencyEvent(emergencyEvent)">
                            ${emergencyEvent.name}
                        </button>
                    </li>
                </ul>
                <hr class="dropdown-divider">
                <button class="dropdown-item"
                        click.trigger="openCreateModal('emergencyEvent')">
                    <i class="bi-plus me-2"></i>${'views.create' | t:{'type': 'model.emergencyEvent'}}
                </button>
            </div>
        </div>

        <div class="${dropUp ? 'dropdown' : 'dropup'}"
             if.bind="!authService.config.useUserLocale">
            <button class="btn btn-link nav-link py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="language-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-globe"></i>
                <span class="d-md-none ms-2">${currentLanguage.name}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="language-menu">
                <li repeat.for="language of languages">
                    <button class="dropdown-item ${language.value === i18n.getLocale() ? 'active' : ''}"
                            click.trigger="changeLanguage(language.value)">
                        ${language.name}
                    </button>
                </li>
            </ul>
        </div>

        <div class="${dropUp ? 'dropdown' : 'dropup'}">
            <button class="btn btn-link nav-link py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="settings-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-gear"></i><span class="d-md-none ms-2">${'views.config' | t}</span>
            </button>
            <div class="dropdown-menu dropdown-menu-lg-end text-nowrap" aria-labelledby="settings-menu">
                <div class="px-3 py-0">
                    <label class="h4 d-flex align-items-end flex-nowrap" for="contextAwareAlertsEnabled">
                        ${'buttons.contextAwareAlerts' | t}
                        <div class="ms-2 form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="contextAwareAlertsEnabled" checked.bind="contextService.contextAwareAlertsEnabled">
                        </div>
                    </label>
                    <div class="mb-3"
                         if.bind="contextService.timeout">
                        <label for="contextAwareAlertsTimeout" class="form-label">${'buttons.interval' | t}</label>
                        <input type="number"
                               autocomplete="off"
                               class="form-control"
                               id="contextAwareAlertsTimeout"
                               value.two-way="contextService.timeout & debounce:1000">
                    </div>
                </div>
                <hr class="dropdown-divider">
                <div class="py-0"
                     if.bind="appConfig.enableBhaptics">
                    <label class="h4 px-3 d-flex align-items-end flex-nowrap"
                           for="bhapticsServiceToggle">
                        <img class="mb-1 me-1" src.bind="'./assets/logo-bhaptics.svg'" style="width: 1rem" class="me-2">
                        bHaptics
                        <div class="ms-2 form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="bhapticsServiceToggle" checked.bind="bhapticsServiceEnabled" change.trigger="toggleBhapticsService()">
                        </div>
                    </label>
                    <div class="px-3 text-body-tertiary text-wrap mb-2">
                        <div if.bind="bhapticsService.status === 'connecting'">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            ${'alerts.bhaptics.connecting' | t}
                        </div>
                        <div if.bind="bhapticsService.status === 'connected'">
                            <i class="bi-circle text-success"></i>
                            ${'alerts.bhaptics.connected' | t}
                        </div>
                        <div if.bind="bhapticsService.status === 'error'">
                            <i class="bi-exclamation-triangle text-warning"></i>
                            ${'alerts.bhaptics.error' | t}
                        </div>
                    </div>
                    <ul class="mb-2 px-3"
                        if.bind="bhapticsService.devices">
                        <li if.bind="bhapticsService.devices"
                            repeat.for="bhapticsDevice of bhapticsService.devices">
                            <div class="d-block">
                                <img if.bind="bhapticsDevice.position === 'Vest'" src.bind="'./assets/icon-vest.svg'" class="me-1" style="width: 1.5rem">
                                ${bhapticDevice.deviceName} ${bhapticsDevice.address}
                                <i class="bi-circle${bhapticsDevice.isConnected ? '-fill text-success' : ''}"></i>
                                <i class="bi-bluetooth${bhapticsDevice.isPaired ? ' text-success' : ''}"></i>
                            </div>
                        </li>
                    </ul>
                    <button class="dropdown-item"
                            disabled.bind="bhapticsService.status !== 'connected'"
                            click.trigger="bhapticsService.pingAll()">
                        <i class="bi-activity me-2"></i>${'buttons.pingAll' | t}
                    </button>
                    <hr class="dropdown-divider">
                </div>
                <a href="#/info" class="dropdown-item"><i class="bi-info-circle me-2"></i>${'views.info.title' | t}</a>
            </div>
        </div>

        <div slot="always-visible" class="order-md-5">
            <button class="btn btn-link nav-link position-relative py-2 px-0 px-lg-2 me-3"
                    type="button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNotifications"
                    aria-controls="offcanvasNotifications">
                <i if.bind="notificationService.initializeState === 'connected'"
                   class="py-2 px-0 bi-bell"></i>
                <i if.bind="notificationService.initializeState === 'disconnected'"
                   class="py-2 px-0 bi-bell-slash"
                   bs-tooltip="title:alerts.notificationService.connectionClosed;placement:right"></i>
                <span class="visually-hidden">${'alerts.notificationService.name' | t}</span>
                <span with.bind="unreadNotifications & signal:'notifications-updated'"
                      if.bind="$this > 0"
                      class="position-absolute start-100 translate-middle badge rounded-pill bg-danger" style="top: 0.25rem;">
                    ${$this}<span class="visually-hidden">unread notifications</span>
                </span>
            </button>
        </div>

        <div class="${dropUp ? 'dropdown' : 'dropup'}"
             if.bind="authService.user">
            <button class="btn btn-link nav-link  py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="profile-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-person-circle"></i><span class="d-md-none ms-2">${authService.userInfo.name}</span>
            </button>
            <div class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="profile-menu">
                <div class="mb-2">
                    <h3 class="ms-2">${authService.user.firstName + ' ' + authService.user.lastName}</h3>
                    <div class="dropdown-item disabled text-nowrap py-0">
                        <i class="bi-person-vcard me-2"></i>${authService.user.username}
                    </div>
                    <div if.bind="authService.userInfo.email"
                         class="dropdown-item disabled text-nowrap py-0">
                        <i class="bi-envelope-at me-2"></i>${authService.userInfo.email}
                    </div>
                </div>
                <div if.bind="authService.user.groups.length">
                    <label class="ms-2">${'propertyKeys.groups' | t}:</label>
                    <ul class="list-unstyled mb-2">
                        <li class="dropdown-item disabled text-nowrap py-0"
                            repeat.for="group of authService.user.groups">
                            <i class="bi-people me-2"></i> ${authService.getGroup(group).name}
                        </li>
                    </ul>
                </div>
                <div if.bind="authService.user.roles.length">
                    <label class="ms-2">${'propertyKeys.roles' | t}:</label>
                    <ul class="list-unstyled mb-2">
                        <li class="dropdown-item disabled text-nowrap py-0"
                            repeat.for="role of authService.user.roles">
                            <i class="bi-person-badge me-2"></i> ${authService.getRole(role).name}
                        </li>
                    </ul>
                </div>
                <div>
                    <label class="ms-2">${'buttons.logoutIn' | t}:</label>
                    <span class="dropdown-item disabled">
                    <i class="bi-clock me-2"></i>${authService.getTokenExpiresIn() | formatNumber:'00:00:00' & signal:'interval-second'}
                </span>
                </div>
                <hr class="dropdown-divider">
                <a class="dropdown-item"
                   href.bind="authService.keycloak.createAccountUrl({redirectUri: window.environment.keycloak.url})"
                   target="_blank">
                    <i class="bi-person-gear me-2"></i>${'buttons.userManagement' | t}
                </a>
                <button class="dropdown-item"
                        click.trigger="authService.close()">
                    <i class="bi-box-arrow-left me-2"></i>${'buttons.logout' | t}
                </button>
            </div>
        </div>
    </nav-bar>

    <toast event="toast" position-class="bottom-0 start-50 translate-middle-x mb-5"></toast>
    <alert class="text-break mb-1" event="app-alert"></alert>

    <router-view class="overflow-auto rounded bg-body"></router-view>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifications" aria-labelledby="offcanvasNotificationsLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNotificationsLabel">${'model.notification' | t:{count: 2}}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex flex-column h-100">
                <div if.bind="notificationService.notifications.length > 0"
                     class="list-group overflow-auto">
                    <button repeat.for="notification of notificationService.notifications"
                            class="list-group-item list-group-item-action ${notification.read ? '' : 'active'}" aria-current="true"
                            click.trigger="readNotification(notification)">
                        <div class="d-flex flex-row">
                            <user-abbreviation if.bind="notification.content.owner"
                                               user-id.bind="notification.content.owner[0]"
                                               class="d-block me-2">
                            </user-abbreviation>
                            <div class="d-flex flex-column w-100 text-break">
                                <div class="d-flex justify-content-between">
                                    <h5 class="mb-1" if.bind="notification.topic === 'model'">${'alerts.notifications.model.' + notification.operationType | t:{type: _.camelCase(notification.contentType)}}</h5>
                                    <h5 class="mb-1" if.bind="notification.topic !== 'model'">${notification.topic} (${notification.operationType})</h5>
                                    <small>${getDate(notification.dateTimeSent) | formatDuration:true:i18n.getLocale() & signal:'interval-second'}</small>
                                    <p type="button" class="hover-item m-0" click.trigger="openNotification(notification)"><i class="bi-box-arrow-up-right"></i></p>
                                </div>
                                <p class="mb-0">${notification.content.text || notification.content.name || notification.content.description}</p>
                            </div>
                        </div>
                    </button>
                </div>
                <div else>
                    ${'multiselect.empty' | t}
                </div>
                <div class="flex-fill mb-3"></div>
                <button class="btn btn-outline-secondary"
                        disabled.bind="notificationService.notifications.length <= 0"
                        click.trigger="notificationService.clearNotifications()">
                    <i class="bi-trash me-2"></i>${'buttons.delete' | t}
                </button>
            </div>
        </div>
    </div>

</template>
