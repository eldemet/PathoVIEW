<template>

    <require from="app.scss"></require>
    <require from="library-aurelia/src/resources/elements/alert"></require>
    <require from="library-aurelia/src/resources/elements/nav-bar"></require>
    <require from="library-aurelia/src/resources/elements/toolbar/toolbar"></require>
    <require from="library-aurelia/src/resources/elements/toast"></require>
    <require from="library-aurelia/src/resources/value-converters/format-number"></require>
    <require from="library-aurelia/src/resources/attributes/bs-tooltip"></require>
    <require from='library-aurelia/src/resources/value-converters/format-date'></require>
    <require from="resources/elements/custom-content-items/custom-content-item-severity.html"></require>
    <require from="resources/elements/user-abbreviation"></require>

    <nav-bar class="bg-body-tertiary rounded mb-1"
             display-is-navigating.bind="true"
             css="navbar-expand-md bg-body-tertiary rounded"
             brand.bind="{iconSource: 'assets/icon-pathocert.png'}">

        <div class="${dropUpUserMenu ? 'dropdown' : 'dropup'}"
             if.bind="!authService.config.useUserLocale">
            <button class="btn btn-link nav-link py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="language-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-translate"></i>
                <span class="d-md-none ms-2">${currentLanguage.name}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="language-menu">
                <li repeat.for="language of languages">
                    <button class="dropdown-item ${language.value === i18n.getLocale() ? 'active' : ''}"
                            click.trigger="changeLanguage(language.value)">
                        ${language.name}
                    </button>
                </li>
            </ul>
        </div>

        <div class="${dropUpUserMenu ? 'dropdown' : 'dropup'}"
             if.bind="contextService.emergencyEvents">
            <button class="btn btn-link nav-link  py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="emergency-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i if.bind="contextService.currentEmergencyEvent" class="bi-hospital-fill"></i>
                <i else class="bi-question-circle-fill"></i>
                <span if.bind="contextService.currentEmergencyEvent" class="d-inline d-md-none d-xxl-inline ms-2">${contextService.currentEmergencyEvent.name}</span>
                <span else class="d-inline d-md-none d-xxl-inline ms-2">${'alerts.noEmergencyEventSelected' | t}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="language-menu">
                <li repeat.for="emergencyEvent of contextService.emergencyEvents">
                    <button class="dropdown-item ${contextService.currentEmergencyEvent === emergencyEvent ? 'active' : ''}"
                            click.trigger="contextService.changeEmergencyEvent(emergencyEvent)">
                        ${emergencyEvent.name}
                    </button>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <button class="dropdown-item"
                            click.trigger="openCreateModal('emergencyEvent')">
                        <i class="bi-plus me-2"></i>${'views.create' | t:{'type': 'model.emergencyEvent'}}
                    </button>
                </li>
            </ul>
        </div>

        <div class="${dropUpUserMenu ? 'dropdown' : 'dropup'}">
            <button class="btn btn-link nav-link  py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="bhaptics-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <img src.bind="'./assets/logo-bhaptics.svg'" style="width: 1rem"><span class="d-md-none ms-2">bHaptics</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="bhaptics-menu">
                <li class="px-3 text-nowrap">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="bhapticsServiceToggle" checked.bind="bhapticsServiceEnabled" change.trigger="toggleBhapticsService()">
                        <label class="form-check-label" for="bhapticsServiceToggle">${'alerts.bhaptics.status' | t}</label>
                    </div>
                </li>
                <li if.bind="bhapticsServiceEnabled">
                    <hr class="dropdown-divider">
                </li>
                <li class="px-3 text-body-tertiary text-nowrap">
                    <div if.bind="bhapticsService.status === 'connecting'">
                        <div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Connecting...</span></div>
                        ${'alerts.bhaptics.connecting' | t}
                    </div>
                    <div if.bind="bhapticsService.status === 'connected'">
                        <i class="bi-circle text-success"></i>
                        ${'alerts.bhaptics.connected' | t}
                    </div>
                    <div if.bind="bhapticsService.status === 'error'">
                        <i class="bi-exclamation-triangle text-warning"></i>
                        ${'alerts.bhaptics.error' | t}
                    </div>
                </li>
                <li if.bind="bhapticsService.devices">
                    <hr class="dropdown-divider">
                </li>
                <li if.bind="bhapticsService.devices"
                    repeat.for="bhapticsDevice of bhapticsService.devices"
                    class="px-3">
                    <span class="d-block">
                        <img if.bind="bhapticsDevice.position === 'Vest'" src.bind="'./assets/icon-vest.svg'" class="me-1" style="width: 1.5rem">
                        ${bhapticDevice.deviceName} ${bhapticsDevice.address}
                        <i class="bi-circle${bhapticsDevice.isConnected ? '-fill text-success' : ''}"></i>
                        <i class="bi-bluetooth${bhapticsDevice.isPaired ? ' text-success' : ''}"></i>
                    </span>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <button class="dropdown-item"
                            disabled.bind="bhapticsService.status !== 'connected'"
                            click.trigger="bhapticsService.pingAll()">
                        <i class="bi-activity me-2"></i>${'buttons.pingAll' | t}
                    </button>
                </li>
            </ul>
        </div>

        <div slot="always-visible" class="order-md-5">
            <button class="btn btn-link nav-link position-relative py-2 px-0 px-lg-2 me-3"
                    type="button"
                    data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasNotifications"
                    aria-controls="offcanvasNotifications">
                <i if.bind="notificationService.initializeState === 'connected'"
                   class="py-2 px-0 bi-bell"></i>
                <i if.bind="notificationService.initializeState === 'disconnected'"
                   class="py-2 px-0 bi-bell-slash"
                   bs-tooltip="title:alerts.notificationService.connectionClosed;placement:right"></i>
                <span class="visually-hidden">${'alerts.notificationService.name' | t}</span>
                <span if.bind="unreadNotifications.length & signal:'notifications-updated'"
                      class="position-absolute start-100 translate-middle badge rounded-pill bg-danger" style="top: 0.25rem;">
                ${unreadNotifications.length}<span class="visually-hidden">unread messages</span>
            </span>
            </button>
        </div>

        <div class="${dropUpUserMenu ? 'dropdown' : 'dropup'}"
             if.bind="authService.userInfo">
            <button class="btn btn-link nav-link  py-2 px-0 px-lg-2 dropdown-toggle" type="button" id="profile-menu"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi-person-circle"></i><span class="d-md-none ms-2">${authService.userInfo.name}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-lg-end" aria-labelledby="language-menu">
                <li class="px-3 text-body-tertiary text-nowrap">
                    <span class="d-block">
                        <i class="bi-person-vcard me-2"></i>${authService.userInfo.name} (${authService.userInfo.preferred_username})
                    </span>
                    <span class="d-block" if.bind="authService.userInfo.email">
                        <i class="bi-envelope-at invisible me-2"></i>${authService.userInfo.email}
                    </span>
                    <span class="d-block">
                        <i class="bi-clock me-2"></i>${'buttons.logoutIn' | t} ${authService.getTokenExpiresIn() | formatNumber:'00:00:00' & signal:'update-logout-in'}
                    </span>
                </li>
                <li>
                    <hr class="dropdown-divider">
                </li>
                <li>
                    <a class="dropdown-item"
                       href.bind="authService.keycloak.createAccountUrl({redirectUri: window.environment.keycloak.url})"
                       target="_blank">
                        <i class="bi-person-gear me-2"></i>${'buttons.userManagement' | t}
                    </a>
                </li>
                <li>
                    <button class="dropdown-item"
                            click.trigger="authService.close()">
                        <i class="bi-box-arrow-left me-2"></i>${'buttons.logout' | t}
                    </button>
                </li>
            </ul>
        </div>
    </nav-bar>

    <toast event="toast" position-class="bottom-0 start-50 translate-middle-x mb-5"></toast>
    <alert class="text-break" event="app-alert"></alert>

    <router-view class="overflow-auto rounded bg-body"></router-view>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifications" aria-labelledby="offcanvasNotificationsLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasNotificationsLabel">${'model.notification' | t:{count: 2}}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="d-flex flex-column h-100">
                <ul if.bind="notificationService.notifications.length > 0"
                    class="list-group overflow-auto">
                    <li repeat.for="notification of notificationService.notifications"
                        class="list-group-item list-group-item-action ${notification.read ? '' : 'active'}" aria-current="true"
                        click.trigger="readNotification(notification)">
                        <div class="d-flex flex-row">
                            <user-abbreviation if.bind="notification.content.owner"
                                               user-id.bind="notification.content.owner[0]"
                                               class="d-block me-2">
                            </user-abbreviation>
                            <div class="d-flex flex-column w-100">
                                <div class="d-flex justify-content-between">
                                    <h5 class="mb-1" if.bind="notification.topic === 'model'">${'alerts.notifications.model.' + notification.operationType | t:{type: _.camelCase(notification.contentType)}}</h5>
                                    <h5 class="mb-1" if.bind="notification.topic !== 'model'">${notification.topic} (${notification.operationType})</h5>
                                    <small>${notification.dateTimeSent | formatDate:'f':i18n.getLocale()}</small>
                                </div>
                                <p class="mb-0">${notification.content.text || notification.content.name || notification.content.description}</p>
                            </div>
                        </div>
                    </li>
                </ul>
                <div else>
                    ${'multiselect.empty' | t}
                </div>
                <div class="flex-fill mb-3"></div>
                <button class="btn btn-outline-secondary"
                        disabled.bind="notificationService.notifications.length <= 0"
                        click.trigger="notificationService.clearNotifications()">
                    <i class="bi-trash me-2"></i>${'buttons.delete' | t}
                </button>
            </div>
        </div>
    </div>

</template>
